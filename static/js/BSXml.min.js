'use strict';var _get=function a(b,c,d){null===b&&(b=Function.prototype);var f=Object.getOwnPropertyDescriptor(b,c);if(f===void 0){var g=Object.getPrototypeOf(b);return null===g?void 0:a(g,c,d)}if('value'in f)return f.value;var h=f.get;return void 0===h?void 0:h.call(d)},_slicedToArray=function(){function a(b,c){var d=[],f=!0,g=!1,h=void 0;try{for(var k,j=b[Symbol.iterator]();!(f=(k=j.next()).done)&&(d.push(k.value),!(c&&d.length===c));f=!0);}catch(l){g=!0,h=l}finally{try{!f&&j['return']&&j['return']()}finally{if(g)throw h}}return d}return function(b,c){if(Array.isArray(b))return b;if(Symbol.iterator in Object(b))return a(b,c);throw new TypeError('Invalid attempt to destructure non-iterable instance')}}(),_createClass=function(){function a(b,c){for(var f,d=0;d<c.length;d++)f=c[d],f.enumerable=f.enumerable||!1,f.configurable=!0,'value'in f&&(f.writable=!0),Object.defineProperty(b,f.key,f)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();function _asyncToGenerator(a){return function(){var b=a.apply(this,arguments);return new Promise(function(c,d){function f(g,h){try{var j=b[g](h),k=j.value}catch(l){return void d(l)}return j.done?void c(k):Promise.resolve(k).then(function(l){f('next',l)},function(l){f('throw',l)})}return f('next')})}}function _possibleConstructorReturn(a,b){if(!a)throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called');return b&&('object'==typeof b||'function'==typeof b)?b:a}function _inherits(a,b){if('function'!=typeof b&&null!==b)throw new TypeError('Super expression must either be null or a function, not '+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}function _toArray(a){return Array.isArray(a)?a:Array.from(a)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')}var BSElement=function(){function a(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:'',c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},d=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[];_classCallCheck(this,a),this.tagName=b,this.props=c,this.children=d}return _createClass(a,[{key:'compile',value:function compile(){var b=document.createElement(this.tagName);return Object.entries(this.props).forEach(function(_ref){var _ref2=_slicedToArray(_ref,2),c=_ref2[0],d=_ref2[1];d&&b.setAttribute(c,d)}),this.children.forEach(function(c){var d=c instanceof a?c.compile():document.createTextNode(c);b.appendChild(d)}),b}}],[{key:'create',value:function create(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:'',c=b.trim().split(' ')[0];return 0===c.length?' ':HTMLTags.has(c)?new a(c):b.trim()}},{key:'createEventMark',value:function createEventMark(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:'',c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:'';if(HTMLEvents.has(b))return new a('BSXml-Event',{eventName:b,functionName:c});throw new Error('invalid event name '+b)}},{key:'createInputMark',value:function createInputMark(){return new a('BSXml-Input')}},{key:'createComponentMark',value:function createComponentMark(b,c,d){return new a('BSXml-Component',{component:b,name:c,args:d})}},{key:'createComponentBlockMark',value:function createComponentBlockMark(b){return new a('bsxc',{hash:b})}},{key:'createStyleBlock',value:function createStyleBlock(b){var c=new a('style');return c.children.push(b),c}}]),a}(),HTMLTags=new Set(['vdRoot','a','abbr','acronym','address','applet','area','article','aside','audio','b','base','basefont','bdi','bdo','big','blockquote','body','br','button','canvas','caption','center','cite','code','col','colgroup','command','datalist','dd','del','details','dir','div','dfn','dialog','dl','dt','em','embed','fieldset','figcaption','figure','font','footer','form','frame','frameset','h1','h2','h3','h4','h5','h6','head','header','hr','html','i','iframe','img','input','ins','isindex','kbd','keygen','label','legend','li','link','map','mark','menu','menuitem','meta','meter','nav','noframes','noscript','object','ol','optgroup','option','output','p','param','pre','progress','q','rp','rt','ruby','s','samp','script','section','select','small','source','span','strike','strong','style','sub','summary','sup','table','tbody','td','textarea','tfoot','th','thead','time','title','tr','track','tt','u','ul','var','video','wbr','xmp']),HTMLEvents=new Set(['abort','afterprint','beforeprint','beforeunload','blur','canplay','canplaythrough','change','click','contextmenu','dblclick','drag','dragend','dragenter','dragleave','dragover','dragstart','drop','durationchange','emptied','ended','error','focus','formchange','forminput','haschange','input','invalid','keydown','keypress','keyup','load','loadeddata','loadedmetadata','loadstart','message','mousedown','mousemove','mouseout','mouseover','mouseup','mousewheel','offline','online','pagehide','pageshow','pause','play','playing','popstate','progress','ratechange','readystatechange','redo','reset','resize','scroll','seeked','seeking','select','stalled','storage','submit','suspend','timeupdate','undo','unload','volumechange','waiting']),Parser=function(){function Parser(){var c=this,b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:'',_ref3=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},_ref3$initElement=_ref3.initElement,a=void 0===_ref3$initElement?'':_ref3$initElement;_classCallCheck(this,Parser),Object.defineProperty(this,'template',{configurable:!1,get:function get(){return c.lines.join('\n')},set:function set(d){c.lines=Array.isArray(d)?d:d.split('\n')}}),this.template=b,this.initElement=a instanceof Function?a:''}return _createClass(Parser,[{key:'compile',value:function compile(){for(var line,dataset=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},child=BSElement.create('vdRoot'),parents=[],i=0;i<this.lines.length;i++)if(line=this.lines[i].trim(),!(line.startsWith('//')||line.startsWith('/*')&&line.endsWith('*/'))){if(line=line.replace(/{{[^}]*}}/g,function(a){return a.replace(/\$/g,'dataset.')}),line.includes('@if')){var conditionTemplate=new ConditionParser(line,this.lines,i);conditionTemplate.compile(dataset).forEach(function(a){child.children.push(a)}),i+=conditionTemplate.lines.length+1;continue}if(line.includes('@for')){var loopTemplate=new LoopParser(line,this.lines,i);loopTemplate.compile(dataset).forEach(function(a){child.children.push(a)}),i+=loopTemplate.lines.length+1;continue}if(line=line.replace(/{{[^}]*}}/g,function(reg){reg=reg.slice(2,-2);try{return eval(reg)}catch(a){throw new Error('cannot calculate the result of '+reg.replace(/dataset[.]/g,'$'))}}),line.startsWith('@')){var _line$slice$split$fil=line.slice(1).split(' ').filter(function(a){return 0<a.length}),_line$slice$split$fil2=_toArray(_line$slice$split$fil),component=_line$slice$split$fil2[0],name=_line$slice$split$fil2[1],args=_line$slice$split$fil2.slice(2);child.children.push(BSElement.createComponentMark(component,name,args.join(' ')));continue}if(line.startsWith('~')){var _line$slice$split$fil3=line.slice(1).split(' ').filter(function(a){return 0<a.length}),_line$slice$split$fil4=_toArray(_line$slice$split$fil3),key=_line$slice$split$fil4[0],value=_line$slice$split$fil4.slice(1);child.props[key]=value.join(' ');continue}if(line.startsWith('!')){var _line$slice$split$fil5=line.slice(1).split(' ').filter(function(a){return 0<a.length}),_line$slice$split$fil6=_slicedToArray(_line$slice$split$fil5,2),eventName=_line$slice$split$fil6[0],functionName=_line$slice$split$fil6[1];child.children.push(BSElement.createEventMark(eventName,functionName));continue}var element=BSElement.create(line);if(('input'===element.tagName||'textarea'===element.tagName)&&child.children.push(BSElement.createInputMark()),line.endsWith('{')&&!line.endsWith('{{'))parents.push(child),child=element,initElement(child,line,this.initElement);else if(line.startsWith('}')&&!line.startsWith('}}')){var parent=parents.pop();parent.children.push(child),child=parent}else child.children.push(element)}if('vdRoot'!==child.tagName||0!==parents.length)throw new Error('template has mistake(s)');return child}}]),Parser}(),ConditionParser=function(_Parser){function ConditionParser(a,b,c){_classCallCheck(this,ConditionParser);try{var d=_possibleConstructorReturn(this,(ConditionParser.__proto__||Object.getPrototypeOf(ConditionParser)).call(this,getTemplateOfBlock(c,b)))}catch(f){throw new Error('cannot find the end of condition, first line is: '+a.replace(/dataset[.]/g,'$'))}return d.definition=a,d}return _inherits(ConditionParser,_Parser),_createClass(ConditionParser,[{key:'compile',value:function compile(){var dataset=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},conditionTargetName=this.definition.match(/@if\({{[^}]*}}\)/g)[0].slice(4,-1).slice(2,-2),conditionTarget=null;try{conditionTarget=eval(conditionTargetName)}catch(a){throw new Error('cannot calculate the result of '+conditionTargetName.replace(/dataset[.]/g,'$'))}var elements=[];return conditionTarget&&_get(ConditionParser.prototype.__proto__||Object.getPrototypeOf(ConditionParser.prototype),'compile',this).call(this,dataset).children.forEach(function(a){elements.push(a)}),elements}}]),ConditionParser}(Parser),LoopParser=function(_Parser2){function LoopParser(a,b,c){_classCallCheck(this,LoopParser);try{var d=_possibleConstructorReturn(this,(LoopParser.__proto__||Object.getPrototypeOf(LoopParser)).call(this,getTemplateOfBlock(c,b)))}catch(f){throw new Error('cannot find the end of loop, first line is: '+a.replace(/dataset[.]/g,'$'))}return d.definition=a,d}return _inherits(LoopParser,_Parser2),_createClass(LoopParser,[{key:'compile',value:function compile(){var dataset=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},loopTargetName=this.definition.match(/@for\({{[^}]*}}\)/g)[0].slice(5,-1).slice(2,-2),loopTarget=null;try{loopTarget=eval(loopTargetName)}catch(a){throw new Error('cannot find a variable called '+loopTargetName.replace(/dataset[.]/g,'$')+' from dataset')}if(!Array.isArray(loopTarget))throw new Error('$'+loopTargetName.replace(/dataset[.]/g,'')+' must be an array');for(var elements=[],index=0;index<loopTarget.length;index++)_get(LoopParser.prototype.__proto__||Object.getPrototypeOf(LoopParser.prototype),'compile',this).call(this,Object.assign({},dataset,{index:index,item:loopTarget[index]})).children.forEach(function(a){elements.push(a)});return elements}}]),LoopParser}(Parser),getTemplateOfBlock=function(){for(var g,a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:-1,b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],c=[],d={left:0,right:0},f=a+1;f<b.length&&(g=b[f].trim(),g.endsWith('{')&&!g.endsWith('{{')?d.left++:g.endsWith('}')&&!g.endsWith('}}')&&d.right++,!(d.right>d.left));f++)c.push(g);if(d.right>d.left)return c;throw new Error},initElement=function(a){var b=1<arguments.length&&arguments[1]!==void 0?arguments[1]:'',c=2<arguments.length&&arguments[2]!==void 0?arguments[2]:'';if(a instanceof BSElement)if(!c){var d={class:(b.match(/[.][\w\d-]* /g)||[]).map(function(f){return f.trim().slice(1)}).join(' '),id:(b.match(/[#][\w\d-]* /)||[''])[0].slice(1).trim()};'a'===a.tagName&&(d.href=(b.match(/"[^]*"/)||[''])[0].slice(1,-1),b.includes('*"')&&(d.target='_blank')),Object.assign(a.props,d)}else c.call(null,a,b)},Renderer=function(){function a(b){var _ref4=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},_ref4$dataset=_ref4.dataset,c=void 0===_ref4$dataset?{}:_ref4$dataset,_ref4$functions=_ref4.functions,d=void 0===_ref4$functions?{}:_ref4$functions;if(_classCallCheck(this,a),b instanceof Parser)this.parser=b;else throw new Error('parser should be an instance of Parser');this.functions=d,this.dataset=c,this.inputs={},this._inputs_=new Map,this.component=null}return _createClass(a,[{key:'render',value:function render(){for(var f=this,b=this.parser.compile(this.dataset),c=b.compile(),d=document.createDocumentFragment();c.childNodes[0];)d.append(c.childNodes[0]);return[].forEach.call(d.querySelectorAll('BSXml-Event'),function(g){var h=g.parentNode,j=g.getAttribute('eventName'),k=g.getAttribute('functionName');if(Object.keys(f.functions).includes(k))h.addEventListener(j,function(){f.functions[k].call(f.functions,{event:window.event,target:h,dataset:f.dataset,inputs:f.inputs,component:f.component,$this:f.component})}),g.remove();else throw new Error('cannot find a function named '+k)}),[].forEach.call(d.querySelectorAll('BSXml-Input'),function(g){var h=g.nextElementSibling,j=uuid(),k=h.getAttribute('dict')||j;Object.defineProperty(f.inputs,k,{configurable:!1,enumerable:!0,get:function get(){return f._inputs_.get(j).value},set:function set(l){f._inputs_.get(j).value=l}}),f._inputs_.set(j,h),g.remove()}),d}}]),a}();DocumentFragment.prototype.paint=function(a){var b=1<arguments.length&&arguments[1]!==void 0?arguments[1]:'before';if(!(a instanceof HTMLElement))throw new Error('target should be an instance of HTMLElement');'before'===b?a.parentNode.insertBefore(this,a):'after'===b?a.nextElementSibling?a.parentNode.insertBefore(this,a.nextElementSibling):a.parentNode.appendChild(this):'replace'===b?a.parentNode.replaceChild(this,a):'push'===b?a.children[0]?a.insertBefore(this,a.children[0]):a.appendChild(this):'append'===b?a.appendChild(this):void 0};var BSXml=function(){function a(){_classCallCheck(this,a)}return _createClass(a,null,[{key:'start',value:function start(){var k=this,g=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],_ref5=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},_ref5$dataset=_ref5.dataset,b=void 0===_ref5$dataset?{}:_ref5$dataset,_ref5$functions=_ref5.functions,c=void 0===_ref5$functions?{}:_ref5$functions,_ref5$init=_ref5.init,d=void 0===_ref5$init?new Function:_ref5$init,_ref5$next=_ref5.next,f=void 0===_ref5$next?new Function:_ref5$next;if(d instanceof Function)d();else throw new Error('init should be a function');if(!(f instanceof Function))throw new Error('next should be a function');if(!Array.isArray(g))throw new Error('templateNodes should be an array');else{for(var h=function NEXT(){f()},j=0;j<g.length;j++)h={NEXT:h,next:function next(){this.NEXT.NEXT?this.NEXT=this.NEXT.NEXT:this.NEXT()}};[].forEach.call(g,function(){var l=_asyncToGenerator(regeneratorRuntime.mark(function m(n){var o,p;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if(!n){r.next=22;break}if(o=null,!(n instanceof HTMLElement)){r.next=10;break}if('BSX'!==n.tagName){r.next=7;break}o=n,r.next=8;break;case 7:throw new Error('found a node whose tagName is not BSX');case 8:r.next=13;break;case 10:try{o=document.querySelector('BSX[name='+n.trim()+']')}catch(s){}if(null!==o){r.next=13;break}throw new Error('cannot find a node named '+n);case 13:return r.next=15,TmplLoader.load(o);case 15:return r.next=17,DataLoader.load(o);case 17:if(r.t0=r.sent,r.t0){r.next=20;break}r.t0={};case 20:p=r.t0,run(o.innerHTML,o,{dataset:Object.assign(p,b),functions:c,next:function next(){h.next()}});case 22:case'end':return r.stop();}},m,k)}));return function(){return l.apply(this,arguments)}}())}}}]),a}(),run=function(a,b){var _ref7=2<arguments.length&&arguments[2]!==void 0?arguments[2]:{},_ref7$dataset=_ref7.dataset,c=_ref7$dataset===void 0?{}:_ref7$dataset,_ref7$functions=_ref7.functions,d=_ref7$functions===void 0?{}:_ref7$functions,_ref7$init=_ref7.init,f=_ref7$init===void 0?new Function:_ref7$init,_ref7$next=_ref7.next,g=_ref7$next===void 0?new Function:_ref7$next,h=new Parser(a),j=new Renderer(h,{dataset:c,functions:d});f(),j.render().paint(b),g()},TmplLoader=function(){function a(){_classCallCheck(this,a)}return _createClass(a,null,[{key:'load',value:function(){var c=_asyncToGenerator(regeneratorRuntime.mark(function d(f){var g;return regeneratorRuntime.wrap(function(j){for(;;)switch(j.prev=j.next){case 0:if(!f.getAttribute('link')||f.getAttribute('ignore-link')){j.next=5;break}return g=f.getAttribute('link').trim(),j.next=4,BSFetch.get(g,{restype:'text'}).then(function(k){f.innerHTML=k}).catch(function(){throw new Error('cannot fetch template from '+g)});case 4:f.setAttribute('ignore-link','true');case 5:case'end':return j.stop();}},d,this)}));return function b(){return c.apply(this,arguments)}}()}]),a}(),DataLoader=function(){function a(){_classCallCheck(this,a)}return _createClass(a,null,[{key:'load',value:function(){var c=_asyncToGenerator(regeneratorRuntime.mark(function d(f){var g;return regeneratorRuntime.wrap(function(j){for(;;)switch(j.prev=j.next){case 0:if(!f.getAttribute('data')){j.next=11;break}return g=f.getAttribute('data').trim(),j.prev=2,j.next=5,BSFetch.get(g);case 5:return j.abrupt('return',j.sent);case 8:throw j.prev=8,j.t0=j['catch'](2),new Error('cannot fetch dataset from '+g);case 11:case'end':return j.stop();}},d,this,[[2,8]])}));return function b(){return c.apply(this,arguments)}}()}]),a}();